# ~/.circleci/config.yml
version: 2
jobs:
  build_project:
    docker:
      - image: haskell:8.4.3
    parallelism: 4
    steps:
      # Git checkout (with caching)
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - checkout

      - save_cache:
          key: source-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - ".git"

      # Dependency installation (with caching)
      - restore_cache:
          keys:
            - cabal_packages-{{ .Branch }}-{{ checksum "Htriple.cabal" }}
            - cabal_packages-{{ .Branch }}-
            - cabal_packages-
            # Install dependencies fresh if we change the dependencies or compilation options to ensure
            # that they are 'mostly' stateless
      - run: cabal update
      - run: cabal install --only-dependencies --enable-tests
      - save_cache:
          key: cabal_packages-{{ .Branch }}-{{ checksum "Htriple.cabal" }}
          paths:
            - "~/.cabal/"

      # Run any builds and tests
      - run: cabal test

workflows:
  version: 2
  build_and_test:
    jobs:
      - build_project
